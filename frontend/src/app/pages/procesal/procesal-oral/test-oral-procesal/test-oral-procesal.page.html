<ion-content class="test-content">
  <!-- Header -->
  <div class="dashboard-header">
    <ion-icon name="chevron-back" class="back-icon" (click)="confirmExit()"></ion-icon>
    <h1 class="header-title">Derecho Procesal Oral</h1>
  </div>

  <!-- Contenido principal -->
  <div class="content-area" *ngIf="!isLoading && !loadingError && getCurrentQuestion()">
    
    <!-- Puntitos de progreso -->
    <div class="progress-dots">
      <div 
        *ngFor="let q of questions; let i = index"
        class="dot"
        [class.completed]="i < (currentQuestionNumber - 1)"
        [class.current]="i === (currentQuestionNumber - 1)">
      </div>
    </div>

    <!-- CategorÃ­a y contador -->
    <div class="category-row">
      <div class="category-chip">
        {{ getCurrentQuestionCategory() }}
        <span *ngIf="shouldShowDifficultyLevel()" class="difficulty-badge">
          {{ getCurrentQuestionDifficulty() }}
        </span>
      </div>
      <div class="question-counter">
        {{ currentQuestionNumber }} de {{ totalQuestions }}
      </div>
    </div>

    <!-- Texto de la pregunta -->
    <div class="question-text">
      <p><strong>{{ getCurrentQuestion()?.questionText }}</strong></p>
    </div>

   <!-- Control de audio para escuchar pregunta -->
    <div class="audio-section">
      <div 
        class="audio-player" 
        [class.playing]="isPlaying"
        [class.completed]="audioCompleted"
        (click)="isPlaying ? pauseAudio() : playAudio()">
        
        <div class="audio-icon-container">
          <ion-icon [name]="getAudioIcon()" class="audio-play-icon"></ion-icon>
        </div>
        
        <div class="audio-text">
          <span class="audio-status">{{ getAudioStatus() }}</span>
          <span class="audio-duration">{{ audioProgress }}</span>
        </div>
      </div>
    </div>

    <!-- Opciones de respuesta -->
    <div class="options-container">
      <div 
        *ngFor="let option of getCurrentQuestionOptions(); let i = index"
        class="option-button"
        [class.selected]="isOptionSelected(option)"        
        [class.correct]="isOptionCorrect(option)"
        [class.incorrect]="isOptionIncorrect(option)"
        [class.disabled]="hasAnsweredCurrentQuestion()"
        [class.clickable]="responseMethod === 'selection' && !hasAnsweredCurrentQuestion()"
        (click)="responseMethod === 'selection' && !hasAnsweredCurrentQuestion() ? selectOptionByClick(option) : null">
        
        <div class="option-letter">{{ getOptionLetter(i) }}</div>
        <div class="option-text">{{ option }}</div>

        <ion-icon 
          *ngIf="shouldShowOptionIcon(option)"
          [name]="getOptionIcon(option)"
          [style.color]="getOptionIconColor(option)"
          class="option-icon">
        </ion-icon>
      </div>
    </div>

    <!-- SecciÃ³n de grabaciÃ³n con micrÃ³fono a la izquierda y reproducir a la derecha -->
      <div class="recording-section" *ngIf="responseMethod === 'voice'">
      <div class="recording-controls-inline">
        
        <!-- BotÃ³n de grabaciÃ³n (izquierda) -->
        <div class="recording-button-container">
          <div 
            class="recording-button" 
            [class.recording]="isRecording"
            [class.has-recording]="hasRecording"
            (click)="toggleRecording()">
            
            <div class="recording-circle">
              <ion-icon [name]="getRecordingIcon()" class="recording-icon"></ion-icon>
            </div>
            
            <div class="recording-pulse" *ngIf="isRecording"></div>
          </div>
          
          <div class="recording-text">
            <span class="recording-status">{{ getRecordingStatus() }}</span>
            <span class="recording-timer" *ngIf="isRecording || hasRecording">{{ recordingTime }}</span>
          </div>
        </div>

        <!-- BotÃ³n de reproducir (derecha) -->
        <div class="replay-button-container" *ngIf="hasRecording">
          <button class="action-button replay" (click)="replayRecording()">
            <ion-icon [name]="isPlayingRecording ? 'pause' : 'play'"></ion-icon>
            <span>{{ getReplayButtonText() }}</span>
          </button>
        </div>
        
      </div>
    </div>

<!-- âœ… PANEL DE EVALUACIÃ“N DESPLEGABLE -->
    <div class="evaluation-panel" *ngIf="showEvaluation" [@slideDown]>
      <div class="evaluation-header" [class.correct]="evaluationResult?.isCorrect" [class.incorrect]="!evaluationResult?.isCorrect">
        <ion-icon [name]="evaluationResult?.isCorrect ? 'checkmark-circle' : 'close-circle'"></ion-icon>
        <span>{{ evaluationResult?.isCorrect ? 'Â¡Correcto!' : 'Incorrecto' }}</span>
      </div>

      <div class="evaluation-body">
        <div class="eval-section">
          <div class="eval-label">Tu respuesta:</div>
          <div class="eval-text">{{ evaluationResult?.userAnswer }}</div>
        </div>

        <div class="eval-section">
          <button 
            class="explanation-play-button" 
            (click)="isPlayingExplanation ? pauseExplanationAudio() : playExplanationAudio()">
            <ion-icon [name]="isPlayingExplanation ? 'pause-circle' : 'play-circle'"></ion-icon>
            <span>{{ isPlayingExplanation ? 'Pausar explicaciÃ³n' : 'Reproducir explicaciÃ³n' }}</span>
          </button>
          <div class="eval-text explanation"><strong>ExplicaciÃ³n:</strong> {{ evaluationResult?.explanation }}</div>
        </div>
      </div>
    </div>

    <!-- BotÃ³n para enviar respuesta -->
    <div class="submit-section" *ngIf="hasRecording && !showEvaluation">
      <button class="submit-voice-button" (click)="submitVoiceAnswer()">
        <ion-icon name="send"></ion-icon>
        <span>Enviar Respuesta</span>
      </button>
    </div>

    <!-- Botones de navegaciÃ³n -->
    <div class="navigation-buttons">
      <ion-button 
        *ngIf="currentQuestionNumber > 1"
        fill="outline" 
        (click)="previousQuestion()"
        class="nav-btn">
        <ion-icon name="chevron-back" slot="start"></ion-icon>
        Anterior
      </ion-button>

      <ion-button 
        *ngIf="currentQuestionNumber < totalQuestions"
        (click)="nextQuestion()"
        [disabled]="!canGoToNext()"
        class="nav-btn primary">
        Siguiente
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </ion-button>

      <ion-button 
        *ngIf="currentQuestionNumber === totalQuestions"
        (click)="nextQuestion()"
        [disabled]="!canGoToNext()"
        class="nav-btn finish">
        Finalizar Test
        <ion-icon name="checkmark-circle" slot="end"></ion-icon>
      </ion-button>
    </div>

    <!-- BotÃ³n para abandonar -->
    <div class="exit-button-container">
      <button class="exit-btn" (click)="confirmExit()">
        <ion-icon name="exit-outline"></ion-icon>
        Abandonar test
      </button>
    </div>

  </div>

  <!-- Loading state -->
  <div class="loading-container" *ngIf="isLoading">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Cargando preguntas orales...</p>
  </div>

  <!-- Error state -->
  <div class="error-container" *ngIf="loadingError">
    <ion-icon name="alert-circle" color="danger"></ion-icon>
    <p>Error al cargar las preguntas</p>
    <ion-button (click)="exitTest()">Volver</ion-button>
  </div>

</ion-content>