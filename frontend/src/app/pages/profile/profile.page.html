<ion-content class="profile-content">
  
  <div class="dashboard-header">
    <ion-icon name="chevron-back" class="back-icon" (click)="goBack()"></ion-icon>
    <h1 class="header-title">Mi Perfil</h1>
  </div>

  <div class="scrollable-content">

    <div class="quick-stats">
      <div class="stat-box">
        <ion-icon name="flame" class="stat-icon streak"></ion-icon>
        <h3>{{ stats.racha_dias_actual }}</h3>
        <p>días de racha</p>
      </div>
      <div class="stat-box">
        <ion-icon name="trophy" class="stat-icon trophy"></ion-icon>
        <h3>{{ stats.total_tests }}</h3>
        <p>sesiones</p>
      </div>
      <div class="stat-box">
        <ion-icon name="trending-up" class="stat-icon level"></ion-icon>
        <h3>{{ getNivelFormatted() }}</h3>
        <p>nivel</p>
      </div>
    </div>

    <!-- INFORMACIÓN PERSONAL -->
    <div class="section">
      <h2 class="section-title" (click)="toggleSection('personalInfo')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <span style="display: flex; align-items: center; gap: 12px;">
          <ion-icon name="person-circle" style="font-size: 24px;"></ion-icon>
          Información Personal
        </span>
        <ion-icon [name]="isSectionExpanded('personalInfo') ? 'chevron-up' : 'chevron-down'"></ion-icon>
      </h2>
      
      <div *ngIf="isSectionExpanded('personalInfo')">
        <div class="info-card">
          <div class="info-item">
            <ion-icon name="person"></ion-icon>
            <div class="info-text">
              <span class="info-label">Nombre Completo</span>
              <span class="info-value">{{ user.nombre }}</span>
            </div>
          </div>
          
          <div class="info-item">
            <ion-icon name="mail"></ion-icon>
            <div class="info-text">
              <span class="info-label">Email</span>
              <span class="info-value">{{ user.email }}</span>
            </div>
          </div>
          
          <div class="info-item">
            <ion-icon name="checkmark-circle"></ion-icon>
            <div class="info-text">
              <span class="info-label">Miembro desde</span>
              <span class="info-value">{{ getFechaRegistroFormatted() }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODO ADAPTATIVO -->
    <div class="section">
      <h2 class="section-title" (click)="toggleSection('adaptiveMode')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <span style="display: flex; align-items: center; gap: 12px;">
          <ion-icon name="analytics" style="font-size: 24px;"></ion-icon>
          Modo Adaptativo
        </span>
        <ion-icon [name]="isSectionExpanded('adaptiveMode') ? 'chevron-up' : 'chevron-down'"></ion-icon>
      </h2>

      <div *ngIf="isSectionExpanded('adaptiveMode')">
        <ion-card class="settings-card">
          <ion-card-header>
            <div class="card-header-with-icon">
              <ion-icon name="analytics-outline" color="primary"></ion-icon>
              <ion-card-title>Modo Adaptativo</ion-card-title>
            </div>
            <ion-card-subtitle>Sistema inteligente de aprendizaje personalizado</ion-card-subtitle>
          </ion-card-header>

          <ion-card-content>
            <div class="setting-item">
              <div class="setting-info" style="flex-direction: column; align-items: flex-start;">
                <div class="setting-label">
                  <ion-icon name="sparkles"></ion-icon>
                  Activar Modo Adaptativo
                </div>
                <div class="setting-description">
                  El sistema analizará tu desempeño y priorizará preguntas de temas donde necesitas refuerzo
                </div>
              </div>
              <ion-toggle 
                [(ngModel)]="adaptiveConfig.enabled" 
                (ionChange)="onAdaptiveModeChange()"
                color="success">
              </ion-toggle>
            </div>

            <div class="adaptive-info" *ngIf="adaptiveConfig.enabled">
              <ion-note color="success">
                <ion-icon name="checkmark-circle"></ion-icon>
                <div>
                  <strong>Modo Adaptativo Activo</strong>
                  <p>Tus próximas sesiones de estudio incluirán más preguntas de los temas donde has tenido dificultades, ayudándote a mejorar de forma más eficiente.</p>
                </div>
              </ion-note>
            </div>

            <div class="adaptive-info-disabled" *ngIf="!adaptiveConfig.enabled">
              <ion-note color="medium">
                <ion-icon name="information-circle-outline"></ion-icon>
                <div>Activa el modo adaptativo para recibir preguntas personalizadas según tu rendimiento.</div>
              </ion-note>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    </div>

    <!-- FRECUENCIA DE ESTUDIO -->
    <div class="section">
      <h2 class="section-title" (click)="toggleSection('studyFrequency')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <span style="display: flex; align-items: center; gap: 12px;">
          <ion-icon name="calendar" style="font-size: 24px;"></ion-icon>
          Frecuencia de Estudio
        </span>
        <ion-icon [name]="isSectionExpanded('studyFrequency') ? 'chevron-up' : 'chevron-down'"></ion-icon>
      </h2>

      <div *ngIf="isSectionExpanded('studyFrequency')">
        <div class="frequency-header">
          <ion-icon name="calendar-outline" class="frequency-icon"></ion-icon>
          <div class="frequency-info">
            <h3>Mi Objetivo Semanal</h3>
            <p class="frequency-subtitle">¿Cuántos días a la semana quieres estudiar?</p>
          </div>
        </div>

        <div class="frequency-selector">
          <div class="days-counter">
            <button class="counter-btn" (click)="decreaseFrecuencia()" [disabled]="frecuenciaConfig.frecuenciaSemanal <= 1">
              <ion-icon name="remove-circle"></ion-icon>
            </button>
            <div class="counter-display">
              <div class="counter-number">{{ frecuenciaConfig.frecuenciaSemanal }}</div>
              <div class="counter-label">días / semana</div>
            </div>
            <button class="counter-btn" (click)="increaseFrecuencia()" [disabled]="frecuenciaConfig.frecuenciaSemanal >= 7">
              <ion-icon name="add-circle"></ion-icon>
            </button>
          </div>

          <div class="frequency-presets">
            <button class="preset-btn" [class.active]="frecuenciaConfig.frecuenciaSemanal === 2" (click)="setFrecuencia(2)">
              2 días (Básico)
            </button>
            <button class="preset-btn" [class.active]="frecuenciaConfig.frecuenciaSemanal === 3" (click)="setFrecuencia(3)">
              3 días (Regular)
            </button>
            <button class="preset-btn" [class.active]="frecuenciaConfig.frecuenciaSemanal === 5" (click)="setFrecuencia(5)">
              5 días (Intensivo)
            </button>
            <button class="preset-btn" [class.active]="frecuenciaConfig.frecuenciaSemanal === 7" (click)="setFrecuencia(7)">
              Diario
            </button>
          </div>
        </div>

        <div class="weekly-progress" *ngIf="cumplimiento">
          <div class="progress-header">
            <span class="progress-label">Esta semana</span>
            <span class="progress-value">{{ cumplimiento.diasEstudiadosSemana }}/{{ cumplimiento.objetivoSemanal }} días</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill" [style.width.%]="cumplimiento.porcentajeCumplimiento"></div>
          </div>
          <p class="progress-message" [class.success]="cumplimiento.porcentajeCumplimiento >= 100">
            <ion-icon [name]="cumplimiento.porcentajeCumplimiento >= 100 ? 'checkmark-circle' : 'time'"></ion-icon>
            {{ getProgressMessage() }}
          </p>
        </div>

        <div class="preferred-days">
          <div class="preferred-days-header">
            <h4>Días preferidos (opcional)</h4>
            <ion-chip class="mode-chip" [color]="frecuenciaConfig.objetivoDias === 'flexible' ? 'primary' : 'warning'">
              <ion-icon [name]="frecuenciaConfig.objetivoDias === 'flexible' ? 'options' : 'calendar'"></ion-icon>
              <ion-label>{{ frecuenciaConfig.objetivoDias === 'flexible' ? 'Flexible' : 'Estricto' }}</ion-label>
            </ion-chip>
          </div>

          <div class="mode-description">
            <p *ngIf="frecuenciaConfig.objetivoDias === 'flexible'">
              <ion-icon name="information-circle"></ion-icon>
              Cualquier día que estudies sumará a tu racha. Los días seleccionados son solo una preferencia.
            </p>
            <p *ngIf="frecuenciaConfig.objetivoDias === 'estricto'">
              <ion-icon name="alert-circle"></ion-icon>
              Solo los días seleccionados ({{ frecuenciaConfig.diasPreferidos.length }}) cuentan para tu racha.
            </p>
          </div>

          <div class="days-grid">
            <button 
              *ngFor="let dia of [0,1,2,3,4,5,6]; let i = index"
              class="day-btn"
              [class.selected]="isDiaSelected(dia)"
              (click)="toggleDia(dia)">
              <div class="day-letter">{{ diasSemana[i].charAt(0) }}</div>
              <div class="day-name">{{ diasSemana[i] }}</div>
            </button>
          </div>

          <div class="days-hint" *ngIf="frecuenciaConfig.diasPreferidos.length === 0">
            <ion-icon name="bulb"></ion-icon>
            <span>Selecciona los días en que prefieres estudiar</span>
          </div>
        </div>

        <div class="reminder-config">
          <div class="reminder-toggle">
            <div class="reminder-info">
              <ion-icon name="notifications-outline"></ion-icon>
              <span>Recordatorios de estudio</span>
            </div>
            <ion-toggle 
              [(ngModel)]="frecuenciaConfig.recordatorioActivo"
              (ionChange)="onRecordatorioChange()"
              color="success">
            </ion-toggle>
          </div>

          <div class="reminder-time" *ngIf="frecuenciaConfig.recordatorioActivo">
            <label>Hora preferida</label>
            <div class="time-selector-container">
              <div class="time-selector">
                <select [(ngModel)]="horaSeleccionada" (change)="onHoraMinutoChange()" class="time-select hora">
                  <option *ngFor="let h of horas" [value]="h">{{ h }}</option>
                </select>
                <span class="separator">:</span>
                <select [(ngModel)]="minutoSeleccionado" (change)="onHoraMinutoChange()" class="time-select minuto">
                  <option *ngFor="let m of minutos" [value]="m">{{ m }}</option>
                </select>
              </div>
              <ion-icon name="time" class="time-icon"></ion-icon>
            </div>
          </div>
        </div>

        <div class="changes-indicator" *ngIf="hasUnsavedChanges">
          <ion-icon name="warning"></ion-icon>
          <span>Tienes cambios sin guardar</span>
        </div>

        <button 
          class="save-frequency-btn" 
          [class.has-changes]="hasUnsavedChanges"
          (click)="saveFrequency()"
          [disabled]="isSaving || !hasUnsavedChanges">
          <ion-icon name="checkmark-circle" *ngIf="!isSaving && hasUnsavedChanges"></ion-icon>
          <ion-icon name="checkmark-done" *ngIf="!isSaving && !hasUnsavedChanges"></ion-icon>
          <ion-spinner name="circular" *ngIf="isSaving"></ion-spinner>
          {{ isSaving ? 'Guardando...' : hasUnsavedChanges ? 'Guardar Cambios' : 'Todo Guardado' }}
        </button>
      </div>
    </div>

    <!-- PROGRESO Y LOGROS -->
    <div class="section">
      <h2 class="section-title" (click)="toggleSection('progress')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <span style="display: flex; align-items: center; gap: 12px;">
          <ion-icon name="trophy" style="font-size: 24px;"></ion-icon>
          Progreso y Logros
        </span>
        <ion-icon [name]="isSectionExpanded('progress') ? 'chevron-up' : 'chevron-down'"></ion-icon>
      </h2>

      <div *ngIf="isSectionExpanded('progress')" class="action-cards">
        <div class="action-card" (click)="viewHistory()">
          <div class="action-icon dashboard">
            <ion-icon name="bar-chart"></ion-icon>
          </div>
          <div class="action-text">
            <h3>Historial de Estudio</h3>
            <p>Ver todas tus sesiones</p>
          </div>
          <ion-icon name="chevron-forward" class="action-arrow"></ion-icon>
        </div>

        <div class="action-card" (click)="viewAchievements()">
          <div class="action-icon achievements">
            <ion-icon name="trophy"></ion-icon>
          </div>
          <div class="action-text">
            <h3>Logros</h3>
            <p>{{ stats.racha_dias_actual }} días - Mejor racha</p>
          </div>
          <ion-icon name="chevron-forward" class="action-arrow"></ion-icon>
        </div>
      </div>
    </div>

    <!-- CONFIGURACIÓN -->
    <div class="section">
      <h2 class="section-title" (click)="toggleSection('configuration')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <span style="display: flex; align-items: center; gap: 12px;">
          <ion-icon name="settings" style="font-size: 24px;"></ion-icon>
          Configuración
        </span>
        <ion-icon [name]="isSectionExpanded('configuration') ? 'chevron-up' : 'chevron-down'"></ion-icon>
      </h2>

      <div *ngIf="isSectionExpanded('configuration')">
        <div class="settings-card">
          <div class="setting-item">
            <div class="setting-info">
              <ion-icon name="moon"></ion-icon>
              <span>Modo oscuro</span>
            </div>
            <ion-toggle [(ngModel)]="settings.darkMode" (ionChange)="saveSettings()" color="success"></ion-toggle>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <ion-icon name="volume-high"></ion-icon>
              <span>Efectos de sonido</span>
            </div>
            <ion-toggle [(ngModel)]="settings.soundEffects" (ionChange)="saveSettings()" color="success"></ion-toggle>
          </div>
          <div class="setting-item">
            <div class="setting-info">
              <ion-icon name="phone-portrait"></ion-icon>
              <span>Vibración</span>
            </div>
            <ion-toggle [(ngModel)]="settings.vibration" (ionChange)="saveSettings()" color="success"></ion-toggle>
          </div>
        </div>

        <div class="help-buttons">
          <button class="help-btn" (click)="getHelp()">
            <ion-icon name="help-circle-outline"></ion-icon>
            Ayuda y Soporte
          </button>
          <button class="help-btn" (click)="aboutApp()">
            <ion-icon name="information-circle-outline"></ion-icon>
            Acerca de Grado Cerrado
          </button>
        </div>

        <button class="logout-btn" (click)="logout()">
          <ion-icon name="log-out"></ion-icon>
          Cerrar Sesión
        </button>
      </div>
    </div>

  </div>

  <app-bottom-nav></app-bottom-nav>
</ion-content>