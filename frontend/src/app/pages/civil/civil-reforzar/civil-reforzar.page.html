<ion-content class="civil-content">
  <!-- Header estilo dashboard -->
  <div class="dashboard-header">
    <ion-icon name="chevron-back" class="back-icon" (click)="goBack()"></ion-icon>
    <h1 class="header-title">Reforzar - Derecho Civil</h1>
  </div>

  <!-- Contenido principal -->
  <div class="content-area">

    <!-- Temas a Reforzar - PRIMERO -->
    <div class="section-card" *ngIf="!isLoading">
      <h2 class="section-title">Temas a Reforzar</h2>
      
      <div class="weak-topics-list" *ngIf="weakTopics.length > 0">
        <div class="weak-topic-card" *ngFor="let topic of weakTopics">
          <div class="topic-header">
            <div class="topic-info">
              <h3>{{ topic.tema }}</h3>
              <p class="topic-area">{{ topic.area }}</p>
            </div>
            <div class="topic-stats">
              <div class="topic-percentage" 
                   [class.critical]="topic.tasaAcierto < 40" 
                   [class.weak]="topic.tasaAcierto >= 40 && topic.tasaAcierto < 60">
                {{ topic.tasaAcierto }}%
              </div>
            </div>
          </div>
          
          <div class="topic-progress-bar">
            <div class="topic-progress-fill" [style.width.%]="topic.tasaAcierto"></div>
          </div>
          
          <div class="topic-meta">
            <span class="meta-item">
              <ion-icon name="help-circle-outline"></ion-icon>
              {{ topic.intentos }} intentos
            </span>
            <span class="meta-item" *ngIf="topic.diasSinPracticar > 0">
              <ion-icon name="time-outline"></ion-icon>
              {{ topic.diasSinPracticar }} días sin practicar
            </span>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="weakTopics.length === 0">
        <ion-icon name="trophy-outline"></ion-icon>
        <p>¡No tienes temas débiles! Sigue practicando.</p>
      </div>
    </div>

    <!-- Sesiones Recientes - DESPLEGABLE -->
    <div class="section-card collapsible" *ngIf="!isLoading && recentSessions.length > 0">
      <div class="collapsible-header" (click)="toggleSessions()">
        <h2 class="section-title">Sesiones Recientes</h2>
        <ion-icon 
          [name]="sessionsExpanded ? 'chevron-up' : 'chevron-down'" 
          class="expand-icon">
        </ion-icon>
      </div>
      
      <div class="collapsible-content" *ngIf="sessionsExpanded">
        <div class="sessions-list">
          <div class="session-card" *ngFor="let session of recentSessions" (click)="viewSession(session)">
            <div class="session-icon">
              <ion-icon name="calendar-outline"></ion-icon>
            </div>
            
            <div class="session-info">
              <h3>{{ session.area }}</h3>
              <p class="session-date">{{ session.date | date:'dd/MM/yyyy' }} • {{ session.duration }}</p>
            </div>
            
            <div class="session-stats">
              <div class="session-score" 
                   [class.good]="session.successRate >= 70" 
                   [class.medium]="session.successRate >= 50 && session.successRate < 70" 
                   [class.low]="session.successRate < 50">
                {{ session.successRate }}%
              </div>
              <p class="session-questions">{{ session.correct }}/{{ session.questions }}</p>
            </div>
            
            <ion-icon name="chevron-forward" class="session-arrow"></ion-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- Selector de cantidad de preguntas -->
    <div class="selection-card">
      <label class="selection-label">Cantidad de preguntas</label>
      <select class="custom-select" [(ngModel)]="selectedQuantity">
        <option [value]="3">3 preguntas</option>
        <option [value]="5">5 preguntas</option>
        <option [value]="10">10 preguntas</option>
        <option [value]="15">15 preguntas</option>
      </select>
    </div>

    <!-- Selector de alcance -->
    <div class="selection-card">
      <label class="selection-label">Alcance del test</label>
      <div class="scope-options">
        <div 
          class="scope-option"
          [class.active]="scopeType === 'all'"
          (click)="selectScope('all')">
          <ion-icon name="globe-outline"></ion-icon>
          <span>Todo Derecho Civil</span>
        </div>
        <div 
          class="scope-option"
          [class.active]="scopeType === 'tema' || scopeType === 'subtema'"
          (click)="selectScope('tema')">
          <ion-icon name="list-outline"></ion-icon>
          <span>Seleccionar tema/subtema</span>
        </div>
      </div>
    </div>

    <!-- Selector de temas con acordeón -->
    <div class="selection-card" *ngIf="scopeType === 'tema' || scopeType === 'subtema'">
      <label class="selection-label">Temas de Derecho Civil</label>
      
      <div class="accordion-list">
        <div 
          *ngFor="let tema of temas" 
          class="accordion-item"
          [class.disabled]="tema.cantidadPreguntas === 0">
          
          <div 
            class="accordion-header"
            [class.active]="expandedTema === tema.id || selectedTemaId === tema.id"
            (click)="toggleTema(tema)">
            <div class="tema-info">
              <span class="tema-nombre">{{ tema.nombre }}</span>
              <span class="tema-count">{{ tema.cantidadPreguntas }} preguntas</span>
            </div>
            <div class="tema-actions">
              <ion-icon 
                *ngIf="selectedTemaId === tema.id && !selectedSubtemaId"
                name="checkmark-circle" 
                class="check-icon">
              </ion-icon>
              <ion-icon 
                [name]="expandedTema === tema.id ? 'chevron-up' : 'chevron-down'"
                class="chevron-icon">
              </ion-icon>
            </div>
          </div>

          <div class="accordion-content" *ngIf="expandedTema === tema.id && tema.subtemas && tema.subtemas.length > 0">
            <div 
              *ngFor="let subtema of tema.subtemas"
              class="subtema-item"
              [class.active]="selectedSubtemaId === subtema.id"
              [class.disabled]="subtema.cantidadPreguntas === 0"
              (click)="selectSubtema(subtema)">
              <div class="subtema-info">
                <span class="subtema-nombre">{{ subtema.nombre }}</span>
                <span class="subtema-count">{{ subtema.cantidadPreguntas }} preguntas</span>
              </div>
              <ion-icon 
                *ngIf="selectedSubtemaId === subtema.id"
                name="checkmark-circle" 
                class="check-icon">
              </ion-icon>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Botón empezar test -->
    <div class="start-button-container">
      <ion-button 
        expand="block" 
        class="start-button"
        (click)="startTest()">
        <ion-icon name="play" slot="start"></ion-icon>
        Empezar Test de Refuerzo
      </ion-button>
    </div>

  </div>

  <!-- Bottom Navigation -->
  <app-bottom-nav></app-bottom-nav>
</ion-content>