<ion-content class="civil-content">
  <!-- Header estilo dashboard -->
  <div class="dashboard-header">
    <ion-icon name="chevron-back" class="back-icon" (click)="goBack()"></ion-icon>
    <h1 class="header-title">Reforzar - Derecho Civil</h1>
  </div>

  <!-- Contenido principal -->
  <div class="content-area">

    <!-- ========================================
         RECOMENDACIÓN DE ESTUDIO (BANNER SIEMPRE VISIBLE)
         ======================================== -->
    <div class="recommendation-banner" *ngIf="!isLoading && getMainRecommendation()">
      <div class="banner-icon">
        <ion-icon name="bulb-outline"></ion-icon>
      </div>
      <div class="banner-content">
        <p class="banner-label">Deberías reforzar</p>
        <h3 class="banner-topic">{{ getMainRecommendation().nombre }}</h3>
        <p class="banner-stats">
          {{ getMainRecommendation().totalErrores }} de {{ getMainRecommendation().totalIntentos }} incorrectas
        </p>
      </div>
      <button class="banner-btn" (click)="selectWeakTopic(getMainRecommendation())">
        <ion-icon name="play-circle-outline"></ion-icon>
      </button>
    </div>

    <!-- ========================================
         PRINCIPALES TEMAS A REFORZAR
         ======================================== -->
    <div class="section">
      <h2 class="section-title"
          (click)="toggleSection('weakTopics')"
          style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <span style="display: flex; align-items: center; gap: 12px;">
          <ion-icon name="trending-down" style="font-size: 24px;"></ion-icon>
          Principales Temas a Reforzar
        </span>
        <ion-icon [name]="isSectionExpanded('weakTopics') ? 'chevron-up' : 'chevron-down'"></ion-icon>
      </h2>

      <div *ngIf="isSectionExpanded('weakTopics')">
        <!-- Skeleton Loading -->
        <div *ngIf="isLoading" class="loading-skeleton">
          <ion-skeleton-text animated style="width: 100%; height: 72px; border-radius: 16px; margin-bottom: 12px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 100%; height: 72px; border-radius: 16px; margin-bottom: 12px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 100%; height: 72px; border-radius: 16px;"></ion-skeleton-text>
        </div>

        <!-- Lista de temas débiles -->
        <div *ngIf="!isLoading && weakTopics.length > 0" class="weak-topics-list-new">
          <div *ngFor="let topic of weakTopics"
               class="topic-card-new"
               (click)="selectWeakTopic(topic)">

            <!-- Indicador de prioridad (círculo izquierda) -->
            <div class="priority-indicator"
                 [class.priority-high]="topic.tasaError >= 70"
                 [class.priority-medium]="topic.tasaError >= 40 && topic.tasaError < 70"
                 [class.priority-low]="topic.tasaError < 40">
            </div>

            <!-- Contenido del card -->
            <div class="topic-content-new">
              <div class="topic-main">
                <h3 class="topic-title-new">{{ topic.nombre }}</h3>
                <p class="topic-subtitle-new">
                  {{ topic.totalErrores }} de {{ topic.totalIntentos }} incorrectas
                </p>
              </div>

              <div class="topic-right">
                <div class="error-badge"
                     [class.badge-high]="topic.tasaError >= 70"
                     [class.badge-medium]="topic.tasaError >= 40 && topic.tasaError < 70"
                     [class.badge-low]="topic.tasaError < 40">
                  {{ topic.tasaError.toFixed(0) }}%
                </div>
                <!-- si quieres puedes quitar esta flecha -->
                <ion-icon name="chevron-forward" class="arrow-icon"></ion-icon>
              </div>
            </div>
          </div>
        </div>

        <!-- Estado vacío -->
        <div *ngIf="!isLoading && weakTopics.length === 0" class="empty-state">
          <ion-icon name="checkmark-circle"></ion-icon>
          <h3>No tienes temas débiles</h3>
          <p>Sigue practicando para mantener tu nivel</p>
        </div>
      </div>
    </div>

    <!-- ========================================
         SESIONES RECIENTES
         ======================================== -->
    <div class="section">
      <h2 class="section-title"
          (click)="toggleSection('recentSessions')"
          style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <span style="display: flex; align-items: center; gap: 12px;">
          <ion-icon name="time" style="font-size: 24px;"></ion-icon>
          Sesiones Recientes
        </span>
        <ion-icon [name]="isSectionExpanded('recentSessions') ? 'chevron-up' : 'chevron-down'"></ion-icon>
      </h2>

<div *ngIf="isSectionExpanded('recentSessions')">
        <div *ngIf="!isLoading && recentSessions.length > 0" class="sessions-list-new">
          <div *ngFor="let session of recentSessions" class="session-wrapper">
            
            <!-- Tarjeta de sesión -->
            <div 
              class="session-card-clean"
              [class.active]="expandedSession === (session.testId || session.id)"
              (click)="viewSession(session)">

              <!-- Contenido principal -->
              <div class="session-info">
                <h3 class="session-title">Test Civil</h3>
                <p class="session-subtitle">{{ session.area || 'Derecho Civil' }}</p>
                <p class="session-date">{{ session.date | date: 'dd/MM/yyyy HH:mm' }}</p>
              </div>

              <!-- Badge naranja -->
              <div class="stat-badge">
                <ion-icon name="checkmark-circle"></ion-icon>
                <span>{{ session.correctAnswers || 0 }}/{{ session.totalQuestions || 0 }}</span>
              </div>

              <!-- Flecha que cambia según expansión -->
              <ion-icon 
                [name]="expandedSession === (session.testId || session.id) ? 'chevron-up' : 'chevron-down'" 
                class="session-arrow">
              </ion-icon>
            </div>

            <!-- Detalles de la sesión (desplegable) -->
            <div *ngIf="expandedSession === (session.testId || session.id)" class="session-details">
              
              <!-- Loading -->
              <div *ngIf="isLoadingDetails" class="details-loading">
                <ion-spinner name="circular"></ion-spinner>
                <p>Cargando preguntas...</p>
              </div>

              <!-- Pelotitas de preguntas -->
              <div *ngIf="!isLoadingDetails && sessionDetails" class="questions-dots">
                <div 
                  *ngFor="let question of sessionDetails.questions; let i = index"
                  class="question-dot"
                  [class.correct]="question.isCorrect"
                  [class.incorrect]="!question.isCorrect"
                  (click)="toggleQuestion(i)">
                  {{ i + 1 }}
                </div>
              </div>

              <!-- Pregunta expandida -->
              <div *ngIf="expandedQuestion !== null && sessionDetails" class="question-detail">
                <div class="question-card">
                  <div class="question-header">
                    <span class="question-number">Pregunta {{ expandedQuestion + 1 }}</span>
                    <ion-icon 
                      name="close-circle" 
                      class="close-icon"
                      (click)="expandedQuestion = null">
                    </ion-icon>
                  </div>

                  <p class="question-text">{{ sessionDetails.questions[expandedQuestion].questionText }}</p>

                  <div class="options-list">
                    <div 
                      *ngFor="let option of getQuestionOptions(sessionDetails.questions[expandedQuestion]); let i = index"
                      class="option-item"
                      [class.selected]="isOptionSelected(sessionDetails.questions[expandedQuestion], option)"
                      [class.correct]="isOptionCorrect(sessionDetails.questions[expandedQuestion], option)"
                      [class.incorrect]="isOptionSelected(sessionDetails.questions[expandedQuestion], option) && !isOptionCorrect(sessionDetails.questions[expandedQuestion], option)">
                      
                      <div class="option-letter">{{ getOptionLetter(i) }}</div>
                      <div class="option-text">{{ option }}</div>
                      
                      <ion-icon 
                        *ngIf="isOptionCorrect(sessionDetails.questions[expandedQuestion], option)"
                        name="checkmark-circle"
                        class="option-icon correct-icon">
                      </ion-icon>
                      <ion-icon 
                        *ngIf="isOptionSelected(sessionDetails.questions[expandedQuestion], option) && !isOptionCorrect(sessionDetails.questions[expandedQuestion], option)"
                        name="close-circle"
                        class="option-icon incorrect-icon">
                      </ion-icon>
                    </div>
                  </div>

                  <div class="explanation-box">
                    <h4>Explicación</h4>
                    <p>{{ sessionDetails.questions[expandedQuestion].explanation || 'No hay explicación disponible' }}</p>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div *ngIf="!isLoading && recentSessions.length === 0" class="empty-state">
          <ion-icon name="document-text"></ion-icon>
          <h3>No hay sesiones recientes</h3>
          <p>Comienza a practicar para ver tu historial</p>
        </div>
      </div>
    </div>

    <!-- ========================================
         TEST DE REFUERZO
         ======================================== -->
    <!-- ojo: id y nombre que usamos en TS -->
    <div class="section test-section" id="test-section">
      <h2 class="section-title"
          (click)="toggleSection('testSection')"
          style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
        <span style="display: flex; align-items: center; gap: 12px;">
          <ion-icon name="school" style="font-size: 24px;"></ion-icon>
          Test de Refuerzo
        </span>
        <ion-icon [name]="isSectionExpanded('testSection') ? 'chevron-up' : 'chevron-down'"></ion-icon>
      </h2>

      <div *ngIf="isSectionExpanded('testSection')">
        <div class="test-config-card">
          
          <!-- Cantidad de preguntas -->
          <div class="config-section">
            <h3>Cantidad de preguntas</h3>
            <div class="quantity-chips">
              <div class="chip"
                   [class.selected]="selectedQuantity === 1"
                   (click)="selectedQuantity = 1">1</div>
              <div class="chip"
                   [class.selected]="selectedQuantity === 5"
                   (click)="selectedQuantity = 5">5</div>
              <div class="chip"
                   [class.selected]="selectedQuantity === 10"
                   (click)="selectedQuantity = 10">10</div>
              <div class="chip"
                   [class.selected]="selectedQuantity === 15"
                   (click)="selectedQuantity = 15">15</div>
            </div>
          </div>

          <!-- Alcance del test -->
          <div class="config-section">
            <h3>Alcance del test</h3>
            
            <!-- Botón "Todo Derecho Civil" -->
            <button 
              class="scope-btn"
              [class.active]="scopeType === 'all'"
              (click)="selectScope('all')">
              <ion-icon name="globe"></ion-icon>
              Todo Derecho Civil
            </button>

            <!-- Botón "Seleccionar tema/subtema" -->
            <button 
              class="scope-btn"
              [class.active]="showThemeSelector"
              (click)="showThemeSelector = !showThemeSelector">
              <ion-icon name="list"></ion-icon>
              Seleccionar tema/subtema
            </button>

            <!-- Selector de temas -->
            <div *ngIf="showThemeSelector" class="theme-selector">
              <div *ngFor="let tema of temas"
                   class="tema-item"
                   [class.has-errors]="tema.hasErrors">
                
                <!-- Header del tema -->
                <div class="tema-header" (click)="toggleTema(tema.id)">
                  <div class="tema-info">
                    <span class="tema-name">
                      {{ tema.nombre }}
                    </span>
                    <span class="tema-count">
                      {{ tema.cantidadPreguntas }} preguntas
                    </span>
                  </div>

                  <div class="tema-actions">
                    <!-- Botón de selección de tema -->
                    <button 
                      class="select-tema-btn"
                      [class.selected]="scopeType === 'tema' && selectedTemaId === tema.id"
                      [class.has-errors]="tema.hasErrors"
                      (click)="onSelectTema(tema, $event)">
                      <ion-icon 
                        *ngIf="tema.hasErrors" 
                        name="alert-circle-outline" 
                        class="btn-error-icon">
                      </ion-icon>
                      {{ scopeType === 'tema' && selectedTemaId === tema.id ? 'Seleccionado' : 'Seleccionar' }}
                    </button>

                    <ion-icon 
                      [name]="expandedTema === tema.id ? 'chevron-up' : 'chevron-down'"
                      class="expand-icon">
                    </ion-icon>
                  </div>
                </div>

                <!-- Subtemas -->
                <div *ngIf="expandedTema === tema.id" class="subtemas-list">
                  <div 
                    *ngFor="let subtema of tema.subtemas"
                    class="subtema-item"
                    [class.has-errors]="subtema.hasErrors"
                    [class.selected]="scopeType === 'subtema' && selectedSubtemaId === subtema.id"
                    (click)="onSelectSubtema(subtema)">
                    
                    <div class="subtema-content">
                      <ion-icon 
                        *ngIf="subtema.hasErrors" 
                        name="alert-circle" 
                        class="error-icon">
                      </ion-icon>
                      <span>{{ subtema.nombre }}</span>
                    </div>

                    <span class="subtema-count">
                      {{ subtema.cantidadPreguntas }} preg.
                    </span>
                  </div>

                  <!-- Mensaje abajo -->
                  <div class="no-errors-message">
                    <ion-icon [name]="tema.hasErrors ? 'alert-circle' : 'checkmark-circle'"></ion-icon>
                    <span *ngIf="tema.hasErrors">
                      Tienes preguntas para reforzar en este tema
                    </span>
                    <span *ngIf="!tema.hasErrors">
                      No tienes preguntas para reforzar en este tema
                    </span>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- Botón iniciar test -->
          <button class="start-test-btn" (click)="startTest()">
            <ion-icon name="play-circle-outline"></ion-icon>
            Empezar Test
          </button>
        </div>
      </div>
    </div>

  </div> <!-- /content-area -->

  <!-- Bottom Navigation -->
  <app-bottom-nav></app-bottom-nav>
</ion-content>